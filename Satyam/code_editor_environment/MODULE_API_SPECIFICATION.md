# Code Execution Module - API Specification

## Overview
Your module (Code Execution Team) is responsible for:
1. Fetching coding problems from MongoDB
2. Executing user code
3. Saving execution results with analysis data for the Code Analyzer team

---

## INPUT: Parameters Fetched by Your Module

### 1. GET /problem/{problem_id}
**Source:** Admin creates this data in MongoDB `coding_problems` collection

**Parameters Fetched:**
```json
{
  "id": "1",
  "title": "Sum Two Numbers",
  "body": "Given two integers a and b, print their sum.",
  "sample_input": "3 5",
  "sample_output": "8",
  "constraints": "-10^9 <= a,b <= 10^9",
  "difficulty": "Easy",
  "languages": ["python", "java", "sql"],
  "time_limit": 10,
  "test_cases": [
    {"input": "3 5", "output": "8"},
    {"input": "-1 1", "output": "0"}
  ]
}
```

**Your Module Uses:**
- `id` - Problem identifier
- `title` - Display to user
- `body` - Problem statement
- `sample_input` - Show to user
- `sample_output` - Show to user
- `constraints` - **Save with execution result**
- `difficulty` - Display to user
- `languages` - Validate which languages supported

---

## PROCESS: Code Execution

### POST /run
**Input from Frontend:**
```json
{
  "language": "python",
  "version": null,
  "files": [{"name": "main", "content": "a, b = map(int, input().split())\nprint(a+b)"}],
  "stdin": "3 5",
  "problem_id": "1"
}
```

**Your Module:**
1. Extract code from `files[0].content`
2. Execute using subprocess (Python/Java/SQL)
3. Capture `stdout`, `stderr`, `exit_code`
4. Fetch `constraint` from problem using `problem_id`
5. Save execution result to MongoDB `code_executions` collection

---

## OUTPUT: Parameters Saved After Code Compilation

### MongoDB Collection: `code_executions`

**Full Document Structure:**
```json
{
  "_id": ObjectId("..."),
  "code_id": "auto-generated by MongoDB",
  "problem_id": "1",
  "language": "python",
  "code": "a, b = map(int, input().split())\nprint(a+b)",
  "constraint": "-10^9 <= a,b <= 10^9",
  "stdout": "8",
  "stderr": "",
  "exit_code": 0,
  "status": "success",
  "timestamp": "2025-12-06T10:30:45.123Z",
  "created_at": "2025-12-06T10:30:45.123Z"
}
```

**Required Fields for Code Analyzer Team:**
| Parameter | Source | Purpose |
|-----------|--------|---------|
| `_id` | MongoDB auto-generated | Unique identifier |
| `code_id` | `_id` converted to string | For querying |
| `problem_id` | From request | Link to original problem |
| `language` | From request | Language used |
| `code` | From request | Source code to analyze |
| `constraint` | Fetched from problem | Context for analysis |
| `stdout` | Execution result | Actual output |
| `stderr` | Execution result | Error output if any |
| `exit_code` | Execution result | 0 = success, non-zero = error |
| `status` | Derived | "success" or "error" |
| `timestamp` | Generation time | When code executed |
| `created_at` | Generation time | For tracking |

---

## Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│ ADMIN (Creates Problems)                                    │
│ Stores in: mongodb://localhost:27017/coding_platform       │
│ Collection: coding_problems                                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼ GET /problem/{problem_id}
         ┌─────────────────────────────────┐
         │ YOUR MODULE (Code Execution)    │
         │ Fetches:                        │
         │ - title                         │
         │ - body                          │
         │ - sample_input/output           │
         │ - constraints ◄──── SAVE THIS   │
         │ - languages                     │
         │ - difficulty                    │
         └─────────────────────────────────┘
                       │
         ┌─────────────┴──────────────┐
         │ USER writes code           │
         │ POST /run with:            │
         │ - language                 │
         │ - code                     │
         │ - stdin                    │
         │ - problem_id               │
         └─────────────┬──────────────┘
                       │
         ┌─────────────▼──────────────┐
         │ Execute Code               │
         │ - Run Python/Java/SQL      │
         │ - Capture output           │
         │ - Capture errors           │
         │ - Get exit code            │
         └─────────────┬──────────────┘
                       │
         ┌─────────────▼──────────────────────────────┐
         │ SAVE to MongoDB                            │
         │ Collection: code_executions                │
         │ Fields:                                    │
         │ - code_id (ObjectId)                       │
         │ - problem_id (from request)                │
         │ - language (from request)                  │
         │ - code (user's code)                       │
         │ - constraint (fetched from problem)        │
         │ - stdout (execution output)                │
         │ - stderr (error output)                    │
         │ - exit_code (execution status)             │
         │ - status (success/error)                   │
         │ - timestamp                                │
         └─────────────┬──────────────────────────────┘
                       │
                       ▼ GET /submissions/{user_id}
         ┌──────────────────────────────┐
         │ CODE ANALYZER TEAM           │
         │ Queries: code_executions     │
         │ Analyzes:                    │
         │ - code quality               │
         │ - correctness                │
         │ - efficiency                 │
         │ - constraint adherence       │
         └──────────────────────────────┘
```

---

## API Endpoints Summary

### Your Module Endpoints

| Endpoint | Method | Input | Output | Purpose |
|----------|--------|-------|--------|---------|
| `/problem/{problem_id}` | GET | problem_id | Fetched problem with constraints | Fetch problem details |
| `/run` | POST | code, language, stdin, problem_id | stdout, stderr, code | Execute code |
| `/submissions/{user_id}` | GET | user_id | Array of execution results | For analyzer team |

---

## Important Notes for Your Team

1. **Constraint Handling:**
   - Constraint is NOT collected from user
   - Constraint is FETCHED from MongoDB problem document
   - Constraint is SAVED with execution for analysis

2. **Code Storage:**
   - Raw source code saved AS-IS
   - No modifications to user code
   - Full code stored for analyzer team

3. **Error Tracking:**
   - Compilation errors → stderr field, status: "error"
   - Runtime errors → stderr field, status: "error"
   - Success → exit_code: 0, status: "success"

4. **Integration with Other Teams:**
   - **Code Analyzer Team:** Queries `code_executions` collection to analyze code
   - **Report Generation Team:** Uses analyzer results to create final report
   - **Admin Team:** Creates problems in `coding_problems` collection

---

## Example: Complete Flow

### Step 1: Admin Creates Problem
```json
db.coding_problems.insertOne({
  "id": "101",
  "title": "Add Two Numbers",
  "body": "Read two numbers and print sum",
  "constraints": "-1000 <= n <= 1000",
  "difficulty": "Easy"
})
```

### Step 2: Frontend Fetches Problem
```
GET /problem/101
Response includes constraint: "-1000 <= n <= 1000"
```

### Step 3: User Submits Code
```json
POST /run
{
  "language": "python",
  "code": "print(3+5)",
  "stdin": "",
  "problem_id": "101"
}
```

### Step 4: Your Module Executes & Saves
```json
// Execution
stdout: "8"
stderr: ""

// Save to code_executions
{
  "code_id": "ObjectId",
  "problem_id": "101",
  "language": "python",
  "code": "print(3+5)",
  "constraint": "-1000 <= n <= 1000",
  "stdout": "8",
  "stderr": "",
  "status": "success"
}
```

### Step 5: Analyzer Team Queries
```
GET /submissions/user123
```
```json
{
  "submissions": [
    {
      "code_id": "...",
      "problem_id": "101",
      "language": "python",
      "code": "print(3+5)",
      "constraint": "-1000 <= n <= 1000",
      "stdout": "8"
    }
  ]
}
```
